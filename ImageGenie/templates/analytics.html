{% extends "base.html" %}

{% block title %}Analytics - Student Result Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-bar me-2"></i>Analytics & Reports</h2>
        <p class="text-muted">Comprehensive analysis of student performance and trends.</p>
        <hr>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-3x mb-2"></i>
                <h4>{{ "%.1f"|format((dept_performance|sum(attribute='1') / dept_performance|length) if dept_performance else 0) }}</h4>
                <small>Average Score</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-trophy fa-3x mb-2"></i>
                <h4>{{ ((dept_performance|sum(attribute='1') / dept_performance|length) >= 75)|int if dept_performance else 0 }}</h4>
                <small>Performance Index</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-users fa-3x mb-2"></i>
                <h4>{{ dept_performance|sum(attribute='2') if dept_performance else 0 }}</h4>
                <small>Total Exams</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-calendar fa-3x mb-2"></i>
                <h4>{{ monthly_trends|length }}</h4>
                <small>Active Months</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Department Performance Chart -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-building me-2"></i>Department Performance</h5>
            </div>
            <div class="card-body">
                {% if dept_performance %}
                <canvas id="deptPerformanceChart" width="400" height="300"></canvas>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No department data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Subject Performance Chart -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-book me-2"></i>Subject Performance</h5>
            </div>
            <div class="card-body">
                {% if subject_performance %}
                <canvas id="subjectPerformanceChart" width="400" height="300"></canvas>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No subject data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Trends Chart -->
{% if monthly_trends %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-line-chart me-2"></i>Performance Trends</h5>
            </div>
            <div class="card-body">
                <canvas id="trendsChart" width="800" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Detailed Tables -->
<div class="row">
    <!-- Department Details -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Department Analysis</h5>
            </div>
            <div class="card-body">
                {% if dept_performance %}
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Avg Score</th>
                                <th>Exams</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dept in dept_performance %}
                            <tr>
                                <td><strong>{{ dept[0] }}</strong></td>
                                <td>{{ "%.1f"|format(dept[1]) }}</td>
                                <td>{{ dept[2] }}</td>
                                <td>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-{% if dept[1] >= 80 %}success{% elif dept[1] >= 60 %}warning{% else %}danger{% endif %}" 
                                             style="width: {{ dept[1] }}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No department performance data available</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Subject Details -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-book-open me-2"></i>Subject Analysis</h5>
            </div>
            <div class="card-body">
                {% if subject_performance %}
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Avg Score</th>
                                <th>Exams</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subject in subject_performance|sort(attribute='1', reverse=True) %}
                            <tr>
                                <td><strong>{{ subject[0][:20] }}{% if subject[0]|length > 20 %}...{% endif %}</strong></td>
                                <td>{{ "%.1f"|format(subject[1]) }}</td>
                                <td>{{ subject[2] }}</td>
                                <td>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-{% if subject[1] >= 80 %}success{% elif subject[1] >= 60 %}warning{% else %}danger{% endif %}" 
                                             style="width: {{ subject[1] }}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No subject performance data available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Performance Insights -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Performance Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-success"><i class="fas fa-arrow-up me-2"></i>Strengths</h6>
                        <ul class="list-unstyled">
                            {% if dept_performance %}
                            {% set best_dept = dept_performance|sort(attribute='1', reverse=True)|first %}
                            <li><i class="fas fa-check-circle text-success me-2"></i>Best performing department: {{ best_dept[0] }} ({{ "%.1f"|format(best_dept[1]) }})</li>
                            {% endif %}
                            {% if subject_performance %}
                            {% set best_subject = subject_performance|sort(attribute='1', reverse=True)|first %}
                            <li><i class="fas fa-check-circle text-success me-2"></i>Top subject: {{ best_subject[0][:30] }} ({{ "%.1f"|format(best_subject[1]) }})</li>
                            {% endif %}
                            {% if monthly_trends and monthly_trends|length > 1 %}
                            {% set latest_trend = monthly_trends|sort(attribute='0')|list %}
                            {% if latest_trend|length >= 2 and latest_trend[-1][1] > latest_trend[-2][1] %}
                            <li><i class="fas fa-check-circle text-success me-2"></i>Improving trend in recent months</li>
                            {% endif %}
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement</h6>
                        <ul class="list-unstyled">
                            {% if dept_performance %}
                            {% set weak_dept = dept_performance|sort(attribute='1')|first %}
                            {% if weak_dept[1] < 60 %}
                            <li><i class="fas fa-exclamation-circle text-warning me-2"></i>{{ weak_dept[0] }} department needs attention ({{ "%.1f"|format(weak_dept[1]) }})</li>
                            {% endif %}
                            {% endif %}
                            {% if subject_performance %}
                            {% set weak_subjects = subject_performance|selectattr('1', 'lt', 60)|list %}
                            {% if weak_subjects %}
                            <li><i class="fas fa-exclamation-circle text-warning me-2"></i>{{ weak_subjects|length }} subject(s) below 60% average</li>
                            {% endif %}
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-info"><i class="fas fa-chart-line me-2"></i>Recommendations</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-lightbulb text-info me-2"></i>Focus on departments with low performance</li>
                            <li><i class="fas fa-lightbulb text-info me-2"></i>Provide additional support for struggling subjects</li>
                            <li><i class="fas fa-lightbulb text-info me-2"></i>Analyze successful patterns for replication</li>
                            {% if monthly_trends and monthly_trends|length < 6 %}
                            <li><i class="fas fa-lightbulb text-info me-2"></i>Collect more historical data for better insights</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-download me-2"></i>Export Analytics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="exportChart('deptPerformanceChart', 'department-performance')">
                            <i class="fas fa-image me-2"></i>Department Chart
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success w-100" onclick="exportChart('subjectPerformanceChart', 'subject-performance')">
                            <i class="fas fa-image me-2"></i>Subject Chart
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-info w-100" onclick="exportChart('trendsChart', 'performance-trends')">
                            <i class="fas fa-image me-2"></i>Trends Chart
                        </button>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('export_results', format='pdf') }}" class="btn btn-danger w-100">
                            <i class="fas fa-file-pdf me-2"></i>Full Report PDF
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Department Performance Chart
{% if dept_performance %}
const deptCtx = document.getElementById('deptPerformanceChart').getContext('2d');
const deptChart = new Chart(deptCtx, {
    type: 'bar',
    data: {
        labels: {{ dept_performance|map(attribute='0')|list|tojson }},
        datasets: [{
            label: 'Average Score',
            data: {{ dept_performance|map(attribute='1')|list|tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}

// Subject Performance Chart
{% if subject_performance %}
const subjectCtx = document.getElementById('subjectPerformanceChart').getContext('2d');
const subjectChart = new Chart(subjectCtx, {
    type: 'doughnut',
    data: {
        labels: {{ subject_performance|map(attribute='0')|list|tojson }},
        datasets: [{
            data: {{ subject_performance|map(attribute='1')|list|tojson }},
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Trends Chart
{% if monthly_trends %}
const trendsCtx = document.getElementById('trendsChart').getContext('2d');
const trendsChart = new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: {{ monthly_trends|map(attribute='0')|list|tojson }},
        datasets: [{
            label: 'Average Score',
            data: {{ monthly_trends|map(attribute='1')|list|tojson }},
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true,
            tension: 0.4
        }, {
            label: 'Number of Exams',
            data: {{ monthly_trends|map(attribute='2')|list|tojson }},
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            fill: false,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                beginAtZero: true,
                max: 100
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: true,
                grid: {
                    drawOnChartArea: false,
                }
            }
        }
    }
});
{% endif %}

// Export chart function
function exportChart(chartId, filename) {
    const canvas = document.getElementById(chartId);
    if (canvas) {
        const link = document.createElement('a');
        link.download = filename + '.png';
        link.href = canvas.toDataURL();
        link.click();
    }
}
</script>
{% endblock %}
